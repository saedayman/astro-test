---
export const prerender = false;

import { Image } from 'astro:assets';
import Layout from '../layouts/Layout.astro';
import Showcase from '../components/Showcase.astro';
import Card from '../components/Card.astro';
import {
  getAccessToken,
  setAccessToken,
  setVisitorId,
  setLocaleCookie,
  setVisitId,
  getTestVariantId,
  setTestVariantId,
  getLanderCookie,
  getLocale,
} from '../lib/cookies';
import HTTP, { apiHandler } from '../lib/http.service';
import type { Session } from './api/session';

// Get session data directly server-side
let sessionData: Session | null = null;
try {
  const accessToken = getAccessToken(Astro.request);
  const variantId = Astro.url.searchParams.get('variantId') || getTestVariantId('style', Astro.request);
  const lander = getLanderCookie(Astro.request) || Astro.url.searchParams.get('lander');
  const parsedVariantId = variantId ? parseInt(variantId, 10) : undefined;

  const meta: { lander?: string } = {};
  if (lander) {
    meta['lander'] = lander;
  }

  const clientAddress = Astro.request.headers.get('x-forwarded-for')?.split(',')[0] || '8.8.8.8';
  const userAgent = Astro.request.headers.get('user-agent') || null;
  const ipAddress = 
    import.meta.env.NODE_ENV === 'development'
      ? import.meta.env.FALLBACK_IP_ADDRESS || '8.8.8.8'
      : Astro.request.headers.get('cf-connecting-ip') ||
        Astro.request.headers.get('x-forwarded-for') ||
        clientAddress ||
        '8.8.8.8';

  const useV2Api = import.meta.env.USE_V2_SESSION_API === 'true';
  const sessionApiUrl = useV2Api ? '/api/web/v2/sessions' : '/api/web/v1/sessions';

  const { data: sessionResponse } = await apiHandler<{ success: boolean; data: Session }>(
    () => HTTP.server({
      method: 'post',
      url: sessionApiUrl,
      data: {
        userAgent,
        ipAddress,
        cookies: Astro.request.headers.get('cookie'),
        lang: 'en',
        url: Astro.url.toString(),
        referrer: Astro.request.headers.get('referer'),
        variantId: !isNaN(parsedVariantId!) ? parsedVariantId : undefined,
        meta,
      },
      headers: accessToken
        ? {
            'X-DOMAIN-NAME': 'perfectautowarranty.com',
            'Content-Type': 'application/json',
            Authorization: `Bearer ${accessToken}`,
            'X-Language': getLocale(Astro.request),
          }
        : {
            'X-DOMAIN-NAME': 'perfectautowarranty.com',
            'Content-Type': 'application/json',
            'X-Language': getLocale(Astro.request),
          },
    })
  );

  if (sessionResponse?.success) {
    console.log('Fetched session data:', sessionResponse.data);
    sessionData = sessionResponse.data;
    // Set cookies on response
    // setAccessToken(sessionData.accessToken!, Astro.response);
    // setTestVariantId('style', String(sessionData.testConfig?.variantId), Astro.response);
    // setVisitorId(sessionData.visitDetails.visitorId, Astro.response);
    // setVisitId(sessionData.visitDetails.visitId, Astro.response);
    // setLocaleCookie(getLocale(Astro.request), Astro.response);
  }
} catch (error) {
  console.error('Failed to fetch session:', error);
}

// Fetch posts from JSONPlaceholder
const response = await fetch('https://jsonplaceholder.typicode.com/posts');
const posts = await response.json();

// Hero image for LCP optimization
const heroImage = 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=412&h=137&q=85&fm=webp&fit=crop';
---

<!-- Preload critical hero image for optimal LCP -->
<link rel="preload" as="image" href={heroImage} fetchpriority="high" />
<link rel="preconnect" href="https://images.unsplash.com" />
<link rel="dns-prefetch" href="https://picsum.photos" />

<!-- Defer non-critical CSS -->
<link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<link rel="preload" href="https://unpkg.com/aos@2.3.1/dist/aos.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<link rel="preload" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />

<Layout title="Astro Blog">
  <!-- Hero section - Priority content for LCP -->
  <Showcase heading="Astro Blog" text="A simple blog built with Astro" showExtra={false} />
  
  <!-- Hero image with high priority for optimal LCP -->
  <section class="hero-image" style="margin-top: -2rem;">
    <img 
      src={heroImage}
      alt="Astro Blog Hero"
      fetchpriority="high"
      decoding="sync"
      style="width: 100%; max-height: 400px; object-fit: cover; display: block;"
    />
  </section>
  
  <!-- Deferred session info section -->
  {sessionData && (
    <section class="page-content" style="content-visibility: auto; contain-intrinsic-size: 300px;">
      <div class="container">
        <Card>
          <h3>Session Information</h3>
          <p><strong>Visitor ID:</strong> {sessionData.visitDetails?.visitorId}</p>
          <p><strong>Location:</strong> {sessionData.visitDetails?.city}, {sessionData.visitDetails?.region}, {sessionData.visitDetails?.country}</p>
          <p><strong>IP Address:</strong> {sessionData.visitDetails?.ip}</p>
          <p><strong>Platform:</strong> {sessionData.visitDetails?.platform}</p>
          <p><strong>Mobile:</strong> {sessionData.visitDetails?.isMobile ? 'Yes' : 'No'}</p>
        </Card>
      </div>
    </section>
  )}
  
  <!-- Deferred blog posts section with content-visibility -->
  <section class="page-content" style="content-visibility: auto;">
    <div class="container">
      <h2>Blog Posts</h2>
      {posts.map(post => (
        <Card>
          <img 
            src={`https://picsum.photos/seed/${post.id}/400/250.webp`} 
            alt={post.title} 
            style="width: 100%; height: 250px; object-fit: cover; margin-bottom: 1rem; border-radius: 8px;" 
            loading="lazy"
            decoding="async"
          />
          <h3>{post.title}</h3>
          <div>
          Post ID: <strong>{post.id}</strong> | User ID: <strong>{post.userId}</strong>
        </div>
          <p>{post.body}</p>  
          <a class="btn" href={`/post/${post.id}`}>Read More</a>
        </Card>
      ))}
    </div>
  </section>
  
  <!-- Deferred image gallery - moved below blog posts -->
  <section class="image-gallery" style="padding: 2rem 0; content-visibility: auto; contain-intrinsic-size: 400px;">
    <div class="container">
      <h2>Gallery</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        <img src="https://images.unsplash.com/photo-1682687220742-aba13b6e50ba?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 1" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
        <img src="https://images.unsplash.com/photo-1682687220063-4742bd7fd538?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 2" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
        <img src="https://images.unsplash.com/photo-1682687221038-404cb8830901?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 3" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
        <img src="https://images.unsplash.com/photo-1682687218147-9806132dc697?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 4" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
        <img src="https://images.unsplash.com/photo-1682687220199-d0124f48f95b?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 5" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
        <img src="https://images.unsplash.com/photo-1682687220566-5599dbbebf11?w=400&h=300&q=75&fm=webp&fit=crop" alt="Optimized Image 6" style="width: 100%; height: 300px; object-fit: cover;" loading="lazy" />
      </div>
    </div>
  </section>
</Layout>

<!-- Heavy Third-Party Scripts - Deferred for better LCP -->
<script is:inline defer src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script is:inline defer src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/gsap@3.11.4/dist/gsap.min.js"></script>
<script is:inline defer src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>

<!-- Google Analytics - Deferred -->
<script is:inline defer src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script is:inline defer>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'GA_MEASUREMENT_ID');
</script>
